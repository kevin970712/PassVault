name: Android Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 22
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "22"
          # Lightweight Gradle dependency caching via setup-java
          cache: gradle

      # More robust Gradle caching + diagnostics (recommended)
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Check Maven Central access (debug)
        run: |
          set -euo pipefail
          curl -I https://repo.maven.apache.org/maven2/ \
            | head -n 1

      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail
          echo "$KEYSTORE_BASE64" | base64 -d > app/keystore.jks

      - name: Build Release APK (retry once on failure)
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          set -euo pipefail
          chmod +x ./gradlew

          build() {
            ./gradlew --no-parallel --stacktrace assembleRelease \
              -Pandroid.injected.signing.store.file="${GITHUB_WORKSPACE}/app/keystore.jks" \
              -Pandroid.injected.signing.store.password="${KEYSTORE_PASSWORD}" \
              -Pandroid.injected.signing.key.alias="${KEY_ALIAS}" \
              -Pandroid.injected.signing.key.password="${KEY_PASSWORD}"
          }

          build || (echo "Gradle failed; retrying in 15s..." && sleep 15 && build)

      - name: Generate categorized release notes
        run: |
          set -euo pipefail
          git fetch --tags --force
          
          TAG="${GITHUB_REF_NAME}"
          PREV_TAG="$(git tag --sort=-creatordate | grep -v "^${TAG}$" | head -n 1 || true)"
          
          # Initialize Release Notes
          echo "# Release ${TAG}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          # Determine the commit range
          if [[ -n "${PREV_TAG}" ]]; then
            RANGE="${PREV_TAG}..${TAG}"
            echo "Changes since ${PREV_TAG}" >> RELEASE_NOTES.md
          else
            RANGE="${TAG}"
            echo "Initial Release" >> RELEASE_NOTES.md
          fi
          echo "" >> RELEASE_NOTES.md
          
          # 1. Dump all non-merge commits to a temp file
          # We check for standard prefixes: feat, fix, chore, docs, refactor, etc.
          git log "${RANGE}" --no-merges --pretty=format:"- %s (%h)" > all_commits.txt
          
          # 2. Extract Features (looks for 'feat' or 'feat(' case-insensitive)
          echo "### Features" >> RELEASE_NOTES.md
          grep -iE "^- feat" all_commits.txt >> RELEASE_NOTES.md || echo "_No new features._" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          # 3. Extract Bug Fixes (looks for 'fix' or 'fix(')
          echo "### Bug Fixes" >> RELEASE_NOTES.md
          grep -iE "^- fix" all_commits.txt >> RELEASE_NOTES.md || echo "_No bug fixes._" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          # 4. Extract Others (Everything that is NOT feat or fix)
          echo "### Other Changes" >> RELEASE_NOTES.md
          grep -ivE "^- (feat|fix)" all_commits.txt >> RELEASE_NOTES.md || echo "_No other changes._" >> RELEASE_NOTES.md
          
          # Cleanup
          rm all_commits.txt
          
          # Debug print to console
          cat RELEASE_NOTES.md

      - name: Create GitHub Release and upload APKs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"

          PRERELEASE=false
          if [[ "$TAG" == *alpha* || "$TAG" == *beta* || "$TAG" == *rc* ]]; then
            PRERELEASE=true
          fi

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release exists: $TAG"
          else
            gh release create "$TAG" \
              --title "$TAG" \
              --notes-file RELEASE_NOTES.md \
              $( [[ "$PRERELEASE" == "true" ]] && echo "--prerelease" )
          fi

          gh release upload "$TAG" app/build/outputs/apk/release/*.apk --clobber
